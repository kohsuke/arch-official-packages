# $Id$
# Maintainer: AndyRTR <andyrtr@archlinux.org>

pkgname=libreoffice
_LOver=3.2.99.1 # = 3.3-alpha1
pkgver=${_LOver}
pkgrel=1
pkgdesc="a productivity suite that is compatible with other major office suites"
arch=('i686' 'x86_64')
_go_tree="3.3"
_ootag=ooo330-m7 # m18/m19 = OOo 3.2.1 RC
license=('LGPL3')
url="http://www.freedesktop.org/wiki/Software/LibreOffice"
install=${pkgname}.install
makedepends=('boost' 'sane' 'perl-archive-zip' 'zip' 'unzip' 'xulrunner' 'unixodbc' 'hsqldb-java'
             'apache-ant' 'gperf' 'poppler' 'kdelibs' 'gconf' 'openjdk6' 'cppunit'
	     'beanshell'  'vigra' 'libldap' 'lucene' 'libmythes' 'junit' 'libwpg'
	     # for additional ooo-build features
	     'mesa>=7.5' 'gstreamer0.10-base>=0.10.26'  'mono>=2.6.1') 
	#'saxon'
depends=("curl>=7.20.0" "hunspell>=1.2.8" "python>=2.6.5" 'libwpd' 'libxaw' "neon>=0.28.6"
          'pango' 'nspr' 'libjpeg' 'libxrandr' 'libgl' 'dbus-glib' "icu>=4.2.1" 'libxslt'
	  'redland' 'libgraphite' 'hyphen' 'lpsolve' 'gcc-libs' 'sh'
	  'hicolor-icon-theme' 'desktop-file-utils' 'gtk2') # keep gtk2 for install script
	  #'saxon'
optdepends=('java-runtime:     adds java support'
             'libcups:          adds printing support'
             'gconf:            adds additional gnome support'
             'nss:              adds support for signed files/macros'
             'pstoedit:         translates PostScript and PDF graphics into other vector formats'
             'poppler:          for shipped pdfimport extension'
             'kdelibs:          for kde integration'
             'libmythes:        for use in thesaurus'
             'hsqldb-java:      default database format for OpenOffice.org'
             'beanshell:        interactive java -- good for prototyping /macros'
             'vigra:            C++ computer vision library, usable in Basebmp'
             'libmspack:        library for Microsoft compression formats for use in FontOOo'
	     'libwpg:		library for importing and converting Corel WordPerfect(tm) Graphics images'
             'libldap:          to get profiles via ldap'
             'lucene:           full-text search engine library for Java needed in the help section'
             'sane:             for scanner access'
             'unixodbc:         adds ODBC database support'
             'mesa:             for the OGLTrans extension'
             'mono:             allows UNO automation with Mono'
             'gstreamer0.10-base: + some gstr-plugins to support multimedia content, e.g. in impress')
backup=(usr/lib/go-openoffice/program/sofficerc)
provides=('openoffice-base')
conflicts=('openoffice-base')
_mirror="http://download.documentfoundation.org/libreoffice/src/"
source=(${_mirror}/${_go_tree}/${pkgname}-build-${_LOver}.tar.gz
libreoffice-build-3.2.99.1.tar.gz
	ArchLinux.patch
#	${pkgname}-${_ootag}.tar.xz
	${_mirror}/{pkgname}-build-${_LOver}-\
{artwork,base,bootstrap,calc,components,extensions,extras,filters,help,impress,l10n,libs-core,libs-extern,libs-extern-sys,libs-gui,postprocess,sdk,testing,ure,writer}.tar.bz2
#	http://download.go-oo.org/DEV300/ooo-cli-prebuilt-3.2.1.tar.bz2
#	http://cairographics.org/releases//cairo-1.4.10.tar.gz
#	http://download.go-oo.org/SRC680/mdbtools-0.6pre1.tar.gz
#	http://download.go-oo.org/SRC680/extras-3.tar.bz2
#	http://download.go-oo.org/SRC680/biblio.tar.bz2
#	http://tools.openoffice.org/unowinreg_prebuild/680//unowinreg.dll
#	http://download.go-oo.org/DEV300/scsolver.2008-10-30.tar.bz2
#	http://download.go-oo.org/libwpd/libwpd-0.8.14.tar.gz
#	http://download.go-oo.org/SRC680/libwps-0.1.2.tar.gz
#	http://download.go-oo.org/SRC680/libwpg-0.1.3.tar.gz
#	http://download.go-oo.org/DEV300/ooo_oxygen_images-2009-06-17.tar.gz
#	http://download.go-oo.org/src/seamonkey-1.1.14.source.tar.gz
#	http://archive.apache.org/dist/ant/binaries/apache-ant-1.7.0-bin.tar.gz
#	http://multidimalgorithm.googlecode.com/files//mdds_0.3.0.tar.bz2
	buildfix_64bit_system_libjpeg.diff)
#options=('!makeflags')
noextract=(ooo-build-${_LOver}-\
{artwork,base,bootstrap,calc,components,extensions,extras,filters,help,impress,l10n,libs-core,libs-extern,libs-extern-sys,libs-gui,postprocess,sdk,testing,ure,writer}.tar.bz2
           ooo-cli-prebuilt-3.2.tar.bz2 cairo-1.4.10.tar.gz mdbtools-0.6pre1.tar.gz extras-3.tar.bz2 biblio.tar.bz2 unowinreg.dll 
           scsolver.2008-10-30.tar.bz2 libwpd-0.8.14.tar.gz libwps-0.1.2.tar.gz libwpg-0.1.3.tar.gz ooo_oxygen_images-2009-06-17.tar.gz)
md5sums=('a87e9441f1ce0bd427ec20696555fa78'
         'a77cc2fdff90146485e0b1f1398bb0d4'
         '33493144d480288425a9d045e4a03239'
         '7ccbeb34f03f95cf47980807f573bc1b'
         '3113682ad0fa810a4c71d125af50911a'
         '41692fd8832325c155aeed5fe02c3519'
         '97aac991f49bcdd6642af431375ba5e3'
         '32c91b5cce09672c9b0d535a312700c7'
         'aa5e50337e39561c63cadcf8fc6fe29c'
         '80ea97fe2621f0e152a6a0a435b8f495'
         '3a42d5e7181cc00eaf18ac2068d47c05'
         '411abf929900273fa4c5cfbe5b60da83'
         '999a656c25bf9b44cea1c37d58698b44'
         '89f10d2fc849e65917cc539a0f413669'
         '52d562eefcc0c14f846b20b0855deec8'
         '6371193bdf5e68dd16c479100e1bcd8f'
         '7dab980fdcf1c591c368ad50e8b6c14d'
         '7c45f516b932b360243f8418acd0fb25'
         'b4c912ebc08cb40822ae0b91bdb43a5c'
         '64b58c0f7be982f4afc69dabe9b1bcc6'
         'fe8a26911aabeb7f1c140a5fc506d494'
         '5b03d5f6ad8973b4f6e96334c3b9a624'
         'b005c4cf9f8e586539ca98c9cfe9bb77')

# source PKGBUILD && mksource
#mksource() {
#	source /etc/makepkg.conf && echo ${SRCDEST}
#        mkdir /tmp/$pkgname-source
#        pushd /tmp/$pkgname-source
#	if [ -e ${SRCDEST}/ooo-build-${_LOver}.tar.gz ]; then
#	      cp $SRCDEST/ooo-build-${_LOver}.tar.gz .
#	 else wget ${_mirror}/${_go_tree}/ooo-build-${_GOver}.tar.gz
#	fi
#	tar -xvf ooo-build-${_GOver}.tar.gz
#	cd ooo-build-${_GOver}
#	./configure --quiet --with-distro=ArchLinux
#	./download --all
#	pushd src; tar -cvJf ../../${pkgname}-${_ootag}.tar.xz clone; popd
#       popd
#}

build() {
	unset J2REDIR; unset J2SDKDIR; unset JAVA_HOME; unset CLASSPATH
	[ -z "${JAVA_HOME}" ] && . /etc/profile.d/openjdk6.sh
	[ -z "${MOZ_PLUGIN_PATH}" ] && . /etc/profile.d/mozilla-common.sh
	[ -z "${ANT_HOME}" ] && . /etc/profile.d/apache-ant.sh

	cd ${srcdir}/ooo-build-${_GOver}

	# our ArchLinux distribution patch until we go upstream
	patch -Np0 -i ${srcdir}/ArchLinux.patch || return 1

	# hotfixes not yet upstream
#	cp ${srcdir}/*.diff ${srcdir}/ooo-build-${_GOver}/patches/hotfixes/
	cp ${srcdir}/buildfix_64bit_system_libjpeg.diff ${srcdir}/ooo-build-${_GOver}/patches/hotfixes/

	# export C(XX)FLAGS
	# http://www.openoffice.org/issues/show_bug.cgi?id=103205
	unset CFLAGS
	unset CXXFLAGS

	if [ "$CARCH" = "x86_64" ]; then
	      EXTRAOPTS="--without-stlport"
	 else EXTRAOPTS="--with-stlport --with-additional-sections=SystemGraphiteWithSTLport"
	fi

#	autoreconf
	./configure --with-distro=ArchLinux \
		--with-build-version="${_GOver} ArchLinux build-${pkgrel} (${_ootag})"\
		--without-git \
		--with-srcdir=${srcdir} \
		--with-max-jobs=${MAKEFLAGS/-j/} \
		--with-installed-ooo-dirname="${pkgname}" \
		--prefix=/usr --exec-prefix=/usr --sysconfdir=/etc \
		--with-docdir=/usr/share/doc/packages/"${pkgname}" \
		--mandir=/usr/share/man \
		--with-lang="" \
		--with-dict=ALL\
		--with-binsuffix=no \
		--enable-cairo\
		--enable-crashdump\
		--enable-evolution2\
		--enable-graphite\
		--disable-gio\
		--disable-kde\
		--enable-kde4\
		--enable-ldap \
		--enable-lockdown\
		--enable-opengl \
		--enable-minimizer \
		--enable-odk\
		--enable-opengl\
		--enable-pdfimport \
		--enable-presenter-console \
		--enable-presenter-extra-ui\
		--enable-report-builder\
		--enable-wiki-publisher \
		--enable-ogltrans \
		--without-fonts\
		--without-afms\
		--without-ppds\
		--without-system-agg\
		--without-system-libwps\
		--without-system-mdds\
		--with-system-cppunit\
		--with-system-libwpg\
		--with-system-redland\
		--without-system-saxon\
		--with-openldap\
		--with-ant-home="/usr/share/java/apache-ant"\
		--with-system-boost\
		--with-system-cairo\
		--with-system-libs\
		--with-system-mythes\
		--with-system-unixodbc-headers\
		--with-system-xrender-headers\
		--with-system-headers\
		--with-alloc=system\
		--with-system-lucene\
		--with-lucene-core-jar=/usr/share/java/lucene-core.jar\
		--with-lucene-analyzers-jar=/usr/share/java/lucene-analyzers.jar\
		$EXTRAOPTS || return 1

# see http://qa.openoffice.org/issues/show_bug.cgi?id=110136
#		--with-system-saxon\
#		--with-saxon-jar=/usr/share/java/saxon/saxon9he.jar\
		
#		--enable-report-builder \
#		--with-additional-sections="OOXMLExport"

	unset MAKEFLAGS
#	./download
	LD_PRELOAD="" make  || return 1
#	make test || return 1
}

package() {
	cd ${srcdir}/ooo-build-${_GOver}
	LD_PRELOAD="" make DESTDIR=${pkgdir} install || return 1

       # install all built dictionaries from source tree
       pushd ${srcdir}/ooo-build-${_GOver}/build/${_ootag}/dictionaries/unxlng?6.pro/bin/
       for i in `ls -1 dict-??.oxt`; do
         install -D -m644 $i ${pkgdir}/usr/lib/"${pkgname}"/share/extension/install/$i || return 1
       done
       popd

	# install all other built extensions
	pushd ${srcdir}/ooo-build-${_GOver}/build/${_ootag}/solver/320/unxlng?6.pro/bin/
         install -D -m644 report-builder.oxt ${pkgdir}/usr/lib/openoffice/share/extension/install/report-builder.oxt || return 1
         install -D -m644 swext/wiki-publisher.oxt ${pkgdir}/usr/lib/"${pkgname}"/share/extension/install/wiki-publisher.oxt || return 1
         install -D -m644 minimizer/presentation-minimizer.oxt ${pkgdir}/usr/lib/"${pkgname}"/share/extension/install/presentation-minimizer.oxt || return 1
         install -D -m644 presenter/presenter-screen.oxt ${pkgdir}/usr/lib/"${pkgname}"/share/extension/install/presenter-screen.oxt || return 1
         install -D -m644 pdfimport/pdfimport.oxt ${pkgdir}/usr/lib/"${pkgname}"/share/extension/install/pdfimport.oxt || return 1
	popd
	
	# fix unopkg call for mktemp, #15410
	sed -i "s:\/bin\/mktemp:\/usr\/bin\/mktemp:" ${pkgdir}/usr/lib/go-openoffice/program/unopkg || return 1
	
	#fix http://bugs.archlinux.org/task/17656
	find ${pkgdir} -perm 444 -exec ls -lh {} \; 
	find ${pkgdir} -perm 444 -exec chmod 644 {} \;
	find ${pkgdir} -perm 555 -exec ls -lh {} \;
	find ${pkgdir} -perm 555 -exec chmod 755 {} \;
}
